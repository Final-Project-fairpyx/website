<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fair Allocation - Bids</title>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>

    <!-- Conflict Selection Table -->
    <h2>Select Course Conflicts</h2>
    <table border="1">
        <tr>
            <th></th> <!-- Empty top-left cell -->
            {% for course in courses %}
                <th>{{ course.name }}</th> <!-- Header row with course names -->
            {% endfor %}
        </tr>
        {% for i in range(num_courses) %}
        <tr>
            <th>{{ courses[i].name }}</th> <!-- Header column with course names -->
            {% for j in range(num_courses) %}
                {% if i != j %}
                <td>
                    <input type="checkbox" id="conflict_{{i}}_{{j}}" name="conflict_{{i}}_{{j}}"
                           onchange="updateConflict({{i}}, {{j}})">
                </td>
                {% else %}
                <td></td> <!-- Empty cell for conflicts with itself -->
                {% endif %}
            {% endfor %}
        </tr>
        {% endfor %}
    </table>

    <!-- Conflict List Display -->
    <h3>Conflict List:</h3>
    <ul id="conflict-list">
        <!-- Conflict items will be dynamically added here -->
    </ul>

    <h1>Enter Bids</h1>
    <form action="/bids" method="post">
        <table>
            <tr>
                <th>Students bids:</th>
                {% for course in courses %}
                <th>{{ course.name }}</th>
                {% endfor %}
            </tr>
            {% for student in students %}
            <tr>
                <td>{{ student.name }}</td>
                {% for course in courses %}
                <td><input type="number" id="bid_{{ student.name }}_{{ course.name }}" name="bid_{{ student.name }}_{{ course.name }}" min="0" max="1000" required></td>
                {% endfor %}
            </tr>
            {% endfor %}
        </table>

        <h2>Select Algorithm</h2>
        <select name="algorithm" id="algorithm-select" required onchange="checkAlgorithm()">
            <option value="TTC">TTC</option>
            <option value="SP">SP</option>
            <option value="TTC-O">TTC-O</option>
            <option value="SP-O">SP-O</option>
            <option value="OC">OC</option>
        </select>
        <br><br>

        <!-- Additional select box for cp options, initially hidden -->
        <div id="cp-options" style="display: none;">
            <h3>Select CP Solver</h3>
            <select name="cp_solver">
                <option value="cp.CBC">cp.CBC</option>
                <option value="cp.MOSEK">cp.MOSEK</option>
                <option value="cp.SCIP">cp.SCIP</option>
                <option value="cp.GLPK_MI">cp.GLPK_MI</option>
                <option value="cp.SCIPY">cp.SCIPY</option>
            </select>
            <br><br>
        </div>

        <button type="button" class="random-button" onclick="randomizeBids()">Random Bids</button>
        <button type="submit">Submit</button>
    </form>

    <script>
        const conflicts = {};

        function updateConflict(i, j) {
            const checkboxIJ = document.getElementById(`conflict_${i}_${j}`);
            const checkboxJI = document.getElementById(`conflict_${j}_${i}`);
            const courseI = `C${i+1}`;
            const courseJ = `C${j+1}`;

            if (checkboxIJ.checked) {
                checkboxJI.checked = true;
                addConflict(courseI, courseJ);
                addConflict(courseJ, courseI);
            } else {
                checkboxJI.checked = false;
                removeConflict(courseI, courseJ);
                removeConflict(courseJ, courseI);
            }

            updateConflictListDisplay();
        }

        function addConflict(course, conflict) {
            if (!conflicts[course]) {
                conflicts[course] = [];
            }
            if (!conflicts[course].includes(conflict)) {
                conflicts[course].push(conflict);
            }
        }

        function removeConflict(course, conflict) {
            if (conflicts[course]) {
                conflicts[course] = conflicts[course].filter(c => c !== conflict);
                if (conflicts[course].length === 0) {
                    delete conflicts[course];
                }
            }
        }

        function updateConflictListDisplay() {
            const conflictList = document.getElementById('conflict-list');
            conflictList.innerHTML = '';

            for (const course in conflicts) {
                const listItem = document.createElement('li');
                listItem.textContent = `${course}: ${conflicts[course].join(', ')}`;
                conflictList.appendChild(listItem);
            }
        }

        function checkAlgorithm() {
            const algorithm = document.getElementById('algorithm-select').value;
            const cpOptions = document.getElementById('cp-options');

            // Show the cp-options select box only for "TTC-O", "SP-O", or "OC"
            if (algorithm === 'TTC-O' || algorithm === 'SP-O' || algorithm === 'OC') {
                cpOptions.style.display = 'block';
            } else {
                cpOptions.style.display = 'none';
            }
        }

        function randomizeBids() {
            let totalBid;
            let numCourses;
            let bids = [];
            let bid;
            let bidValue;

            {% for student in students %}
                totalBid = 1000;
                numCourses = {{ courses | length }};
                bids = [];

                console.log('Randomizing bids for {{ student.name }}');

                // Generate random bids for the courses
                for (let i = 0; i < numCourses - 1; i++) {
                    bid = Math.floor(Math.random() * (totalBid - (numCourses - i - 1)));
                    bids.push(bid);
                    totalBid -= bid;
                }
                // Assign remaining total to the last course
                bids.push(totalBid);

                console.log('Bids generated:', bids);

                // Shuffle bids to randomize distribution
                bids = bids.sort(() => Math.random() - 0.5);

                console.log('Bids after shuffle:', bids);

                // Assign bids to the inputs
                {% for course in courses %}
                    bidValue = bids.pop();
                    console.log('Assigning bid for {{ student.name }} in {{ course.name }}:', bidValue);
                    document.getElementById('bid_{{ student.name }}_{{ course.name }}').value = bidValue;
                {% endfor %}
            {% endfor %}
        }
    </script>
</body>
</html>
